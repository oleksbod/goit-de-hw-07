version: "3.9"

x-airflow-common: &airflow-common
    image: apache/airflow:2.8.1
    environment: &airflow-env
        AIRFLOW__CORE__EXECUTOR: CeleryExecutor
        AIRFLOW__CORE__FERNET_KEY: ""
        AIRFLOW__CORE__LOAD_EXAMPLES: "False"
        AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.basic_auth"
        AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow
        AIRFLOW__CELERY__RESULT_BACKEND: db+postgresql://airflow:airflow@postgres/airflow
        AIRFLOW__CELERY__BROKER_URL: redis://redis:6379/0
    volumes:
        - ./dags:/opt/airflow/dags
        - ./logs:/opt/airflow/logs
        - ./plugins:/opt/airflow/plugins
    user: "${AIRFLOW_UID:-50000}:0"
    depends_on:
        postgres:
            condition: service_healthy
        redis:
            condition: service_healthy
        mysql:
            condition: service_started

services:
    postgres:
        image: postgres:13
        environment:
            POSTGRES_USER: airflow
            POSTGRES_PASSWORD: airflow
            POSTGRES_DB: airflow
        volumes:
            - postgres-db-volume:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD", "pg_isready", "-U", "airflow"]
            interval: 5s
            timeout: 5s
            retries: 5

    redis:
        image: redis:latest
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5

    mysql:
        image: mysql:8.0
        environment:
            MYSQL_ROOT_PASSWORD: airflow
            MYSQL_DATABASE: olympic_dataset
            MYSQL_USER: airflow
            MYSQL_PASSWORD: airflow
        command: --default-authentication-plugin=mysql_native_password
        ports:
            - "3307:3306"
        volumes:
            - mysql-db-volume:/var/lib/mysql

    airflow-webserver:
        <<: *airflow-common
        command: webserver
        ports:
            - "8080:8080"
        healthcheck:
            test: ["CMD", "curl", "--fail", "http://localhost:8080/health"]
            interval: 10s
            timeout: 5s
            retries: 5

    airflow-scheduler:
        <<: *airflow-common
        command: scheduler

    airflow-init:
        image: apache/airflow:2.8.1
        depends_on:
            - postgres
        entrypoint: /bin/bash
        command:
            - -c
            - |
                airflow db init &&
                airflow users create \
                  --username airflow \
                  --password airflow \
                  --firstname Admin \
                  --lastname User \
                  --role Admin \
                  --email admin@example.com
        volumes:
            - ./dags:/opt/airflow/dags
            - ./logs:/opt/airflow/logs
            - ./plugins:/opt/airflow/plugins
        environment:
            AIRFLOW__CORE__EXECUTOR: CeleryExecutor
            AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@postgres/airflow

    airflow-worker:
        <<: *airflow-common
        command: celery worker
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy

volumes:
    postgres-db-volume:
    mysql-db-volume:
